<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Sun Â· Moon Â· Star ì¹´ë“œ ê²Œì„</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #fdf6e3 0, #f0f4ff 40%, #e7ecf5 100%);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      color: #222;
    }

    .game-container {
      margin: 24px;
      max-width: 480px;
      width: 100%;
      background: #ffffffdd;
      backdrop-filter: blur(8px);
      border-radius: 18px;
      padding: 16px 16px 24px;
      box-shadow:
        0 18px 45px rgba(15, 23, 42, 0.18),
        0 0 0 1px rgba(148, 163, 184, 0.2);
    }

    h1 {
      margin: 0 0 8px;
      font-size: 22px;
      letter-spacing: 0.04em;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }

    h1 span.logo {
      font-size: 18px;
      padding: 2px 10px;
      border-radius: 999px;
      background: linear-gradient(90deg, #f97316, #ec4899, #6366f1);
      color: white;
    }

    .subtitle {
      font-size: 13px;
      text-align: center;
      color: #6b7280;
      margin-bottom: 6px;
    }

    .mode-chip {
      text-align: center;
      margin-bottom: 10px;
    }

    .chip-mode {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      background: #eef2ff;
      color: #4f46e5;
      gap: 6px;
    }

    .chip-mode.tutorial {
      background: #ecfdf5;
      color: #047857;
    }

    .chip-mode.normal {
      background: #eef2ff;
      color: #4f46e5;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 10px;
      color: #4b5563;
    }

    .status-label {
      font-weight: 600;
      color: #111827;
    }

    .status-dim {
      opacity: 0.6;
    }

    .zone-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #6b7280;
      margin: 10px 4px 4px;
    }

    .card-row {
      display: flex;
      gap: 6px;
      min-height: 80px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }

    .card {
      min-width: 60px;
      min-height: 80px;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 6px;
      box-sizing: border-box;
      cursor: pointer;
      position: relative;
      background: #f9fafb;
      transition: transform 0.08s ease, box-shadow 0.08s ease, border-color 0.08s ease;
      font-size: 20px;
      font-weight: 700;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.18);
    }

    .card.small {
      min-width: 46px;
      min-height: 64px;
      font-size: 16px;
    }

    .card.disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .card-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-top: 2px;
      color: #4b5563;
    }

    .card.red {
      border-color: rgba(248, 113, 113, 0.8);
      background: radial-gradient(circle at top, #fee2e2, #fef2f2);
      color: #991b1b;
    }

    .card.blue {
      border-color: rgba(96, 165, 250, 0.8);
      background: radial-gradient(circle at top, #dbeafe, #eff6ff);
      color: #1d4ed8;
    }

    .card.green {
      border-color: rgba(52, 211, 153, 0.8);
      background: radial-gradient(circle at top, #d1fae5, #ecfdf5);
      color: #047857;
    }

    .card.special.sun {
      background: radial-gradient(circle at top, #facc15, #f97316);
      color: #fefce8;
      border-color: rgba(202, 138, 4, 0.9);
      font-size: 22px;
    }

    .card.special.moon {
      background: radial-gradient(circle at top, #0f172a, #1f2937);
      color: #e5e7eb;
      border-color: rgba(148, 163, 184, 0.9);
      font-size: 22px;
    }

    .card.special.star {
      background: radial-gradient(circle at top, #312e81, #1f2937);
      color: #facc15;
      border-color: rgba(129, 140, 248, 0.9);
      font-size: 22px;
    }

    .card.selected {
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.9);
    }

    .controls {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(90deg, #6366f1, #0ea5e9);
      color: white;
      box-shadow: 0 6px 18px rgba(37, 99, 235, 0.35);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, filter 0.08s ease;
    }

    button:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 8px 24px rgba(37, 99, 235, 0.45);
    }

    button:disabled {
      opacity: 0.35;
      cursor: default;
      box-shadow: none;
      transform: none;
      filter: none;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
      box-shadow: none;
    }

    .btn-secondary:hover {
      box-shadow: 0 4px 12px rgba(148, 163, 184, 0.6);
    }

    .log {
      margin-top: 12px;
      font-size: 12px;
      padding: 8px 10px;
      background: #f9fafb;
      border-radius: 12px;
      border: 1px solid rgba(209, 213, 219, 0.8);
      max-height: 140px;
      overflow-y: auto;
      line-height: 1.5;
    }

    .log-line {
      margin-bottom: 3px;
    }

    .log-line span.tag {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-right: 4px;
      color: #6b7280;
    }

    .tag-system {
      color: #6366f1;
    }

    .tag-score {
      color: #0f766e;
    }

    .tag-warn {
      color: #b91c1c;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #e5e7eb;
      color: #374151;
    }

    .chip.red { background: #fee2e2; color: #b91c1c; }
    .chip.blue { background: #dbeafe; color: #1d4ed8; }
    .chip.green { background: #dcfce7; color: #15803d; }

    .chip-target {
      background: #eef2ff;
      color: #4f46e5;
    }

    .chip-round {
      background: #ecfdf5;
      color: #047857;
    }

    .chip-fail {
      background: #fef2f2;
      color: #b91c1c;
    }

    .score-breakdown {
      font-size: 11px;
      margin-top: 4px;
      color: #4b5563;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      background: #e5e7eb;
      margin-right: 4px;
      margin-bottom: 2px;
    }

    .pill.bonus {
      background: #ecfdf5;
      color: #047857;
    }

    .pill.multiplier {
      background: #fef9c3;
      color: #92400e;
    }

    .hint {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
      text-align: center;
    }

    .hint-strong {
      font-weight: 600;
      color: #374151;
    }
  </style>
</head>
<body>
  <div class="game-container">
    <h1>
      <span class="logo">â˜€ ğŸŒ™ â­</span>
      í•´ Â· ë‹¬ Â· ë³„
    </h1>
    <div class="subtitle">ë¨¼ì € ê°„ë‹¨í•œ ì—°ìŠµ ëª¨ë“œì—ì„œ ë“œë¡œìš° & ì¹´ë“œ ì„ íƒì„ ìµíŒ ë’¤, ë³¸ ê²Œì„ìœ¼ë¡œ ë„˜ì–´ê°€ìš”.</div>

    <div class="mode-chip">
      <span id="modeChip" class="chip-mode tutorial">â— TUTORIAL Â· ì—°ìŠµ ëª¨ë“œ</span>
    </div>

    <div class="status-bar">
      <div><span class="status-label">ë¼ìš´ë“œ:</span> <span id="round">íŠœí† ë¦¬ì–¼</span></div>
      <div><span class="status-label">ëª©í‘œ ì ìˆ˜:</span> <span id="targetScore" class="status-dim">ì—°ìŠµ</span></div>
      <div><span class="status-label">í˜„ì¬ ì ìˆ˜:</span> <span id="currentScore">0</span></div>
    </div>

    <div class="zone-title">í•„ë“œ (5ì¥ ëª¨ì´ë©´ ìë™ ì±„ì )</div>
    <div id="field" class="card-row"></div>

    <div class="zone-title">í˜„ì¬ ì„ íƒ ê°€ëŠ¥í•œ ì¹´ë“œ (3ì¥)</div>
    <div id="hand" class="card-row"></div>

    <div class="zone-title">íŠ¹ìˆ˜ ì¹´ë“œ</div>
    <div id="specials" class="card-row"></div>

    <div class="controls">
      <button id="drawBtn">ğŸ´ 3ì¥ ë“œë¡œìš°</button>
      <button id="resetBtn" class="btn-secondary">ğŸ”„ ì „ì²´ ë¦¬ì…‹</button>
    </div>
    <div class="hint">
      <span class="hint-strong">íŠœí† ë¦¬ì–¼:</span> ë¨¼ì € <b>3ì¥ ë“œë¡œìš°</b> â†’ ë§ˆìŒì— ë“œëŠ” ì¹´ë“œ <b>1ì¥ í´ë¦­</b> â†’ í•„ë“œë¥¼ 5ì¥ê¹Œì§€ ì±„ì›Œë³´ì„¸ìš”.
    </div>

    <div class="zone-title">ë²„ë ¤ì§„ ì¹´ë“œ</div>
    <div id="discard" class="card-row"></div>

    <div class="log" id="log"></div>
  </div>

  <script>
    // ---- ê²Œì„ ìƒíƒœ ----
    const COLORS = ["red", "blue", "green"];
    const COLOR_LABEL = { red: "RED", blue: "BLUE", green: "GREEN" };
    const TARGET_SCORE_BASE = 40; // ë³¸ê²Œì„ ê¸°ì¤€ ê¸°ë³¸ ëª©í‘œ ì ìˆ˜

    // ëª¨ë“œ: "tutorial" | "normal"
    let mode = "tutorial";
    let tutorialStep = 0; // íŠœí† ë¦¬ì–¼ íŒíŠ¸ ë‹¨ê³„

    let round = 1;
    let targetScore = TARGET_SCORE_BASE;
    let field = [];    // í•„ë“œ ìœ„ 5ì¥ê¹Œì§€
    let hand = [];     // í˜„ì¬ ì„ íƒ ê°€ëŠ¥í•œ 3ì¥
    let discardPile = [];
    let specials = [
      { type: "sun", name: "Sun", used: false },
      { type: "moon", name: "Moon", used: false },
      { type: "star", name: "Star", used: false },
    ];

    let sunUsedThisRound = false;
    let awaitingMoonSelection = false;
    let awaitingStarFieldSelection = false;
    let awaitingStarColorSelection = null; // ì„ íƒëœ í•„ë“œ ì¹´ë“œ index

    const fieldEl = document.getElementById("field");
    const handEl = document.getElementById("hand");
    const specialsEl = document.getElementById("specials");
    const discardEl = document.getElementById("discard");
    const drawBtn = document.getElementById("drawBtn");
    const resetBtn = document.getElementById("resetBtn");
    const roundEl = document.getElementById("round");
    const targetScoreEl = document.getElementById("targetScore");
    const currentScoreEl = document.getElementById("currentScore");
    const logEl = document.getElementById("log");
    const modeChipEl = document.getElementById("modeChip");

    // ---- ìœ í‹¸ í•¨ìˆ˜ ----
    function log(message, tag = "system") {
      const div = document.createElement("div");
      div.className = "log-line";
      const span = document.createElement("span");
      span.className = "tag " + (tag === "score" ? "tag-score" : tag === "warn" ? "tag-warn" : "tag-system");
      span.textContent = tag.toUpperCase();
      div.appendChild(span);
      div.appendChild(document.createTextNode(message));
      logEl.prepend(div);
    }

    function createNumberCard() {
      const value = Math.floor(Math.random() * 9) + 1; // 1~9
      const color = COLORS[Math.floor(Math.random() * COLORS.length)];
      return { type: "number", value, color };
    }

    function createDeckSample(n) {
      const arr = [];
      for (let i = 0; i < n; i++) arr.push(createNumberCard());
      return arr;
    }

    // íŠœí† ë¦¬ì–¼ìš© ê³ ì • ë“œë¡œìš° íŒ¨í„´ (ìƒ‰/ìˆ«ì ì ë‹¹íˆ ì„ì–´ì„œ ì²´í—˜ìš©)
    const tutorialHands = [
      [
        { type: "number", value: 3, color: "red" },
        { type: "number", value: 5, color: "blue" },
        { type: "number", value: 7, color: "green" },
      ],
      [
        { type: "number", value: 2, color: "red" },
        { type: "number", value: 4, color: "red" },
        { type: "number", value: 9, color: "blue" },
      ],
      [
        { type: "number", value: 6, color: "green" },
        { type: "number", value: 8, color: "green" },
        { type: "number", value: 1, color: "blue" },
      ],
    ];

    function render() {
      renderField();
      renderHand();
      renderSpecials();
      renderDiscard();
      const scoreResult = calculateFieldScore();
      currentScoreEl.textContent = scoreResult.total;

      if (mode === "tutorial") {
        roundEl.textContent = "íŠœí† ë¦¬ì–¼";
        targetScoreEl.textContent = "ì—°ìŠµ";
        targetScoreEl.classList.add("status-dim");
        modeChipEl.textContent = "â— TUTORIAL Â· ì—°ìŠµ ëª¨ë“œ";
        modeChipEl.className = "chip-mode tutorial";
      } else {
        roundEl.textContent = round;
        targetScoreEl.textContent = targetScore;
        targetScoreEl.classList.remove("status-dim");
        modeChipEl.textContent = "â— NORMAL Â· ë³¸ ê²Œì„";
        modeChipEl.className = "chip-mode normal";
      }
    }

    function renderField() {
      fieldEl.innerHTML = "";
      field.forEach((card, index) => {
        const cardEl = document.createElement("div");
        cardEl.className = "card " + (card.type === "number" ? card.color : "");
        if (awaitingStarFieldSelection && mode === "normal") {
          cardEl.classList.add("selectable");
        } else {
          cardEl.classList.add("disabled");
        }
        if (card.type === "number") {
          cardEl.textContent = card.value;
          const label = document.createElement("div");
          label.className = "card-label";
          label.textContent = COLOR_LABEL[card.color];
          cardEl.appendChild(label);
        } else {
          cardEl.textContent = "?";
        }

        if (awaitingStarFieldSelection && mode === "normal") {
          cardEl.addEventListener("click", () => {
            awaitingStarFieldSelection = false;
            awaitingStarColorSelection = index;
            log("ìƒ‰ì„ ë°”ê¿€ ì¹´ë“œë¥¼ ì„ íƒí–ˆìŠµë‹ˆë‹¤. ìƒ‰ìƒ(RED/BLUE/GREEN)ì„ ê³ ë¥´ì„¸ìš”.", "system");
            showColorChoiceOverlay();
          });
        }

        fieldEl.appendChild(cardEl);
      });

      // ë¹ˆ ì¹¸ í‘œì‹œ
      for (let i = field.length; i < 5; i++) {
        const empty = document.createElement("div");
        empty.className = "card small disabled";
        empty.style.borderStyle = "dashed";
        empty.style.background = "transparent";
        empty.style.boxShadow = "none";
        empty.textContent = "+";
        fieldEl.appendChild(empty);
      }
    }

    function renderHand() {
      handEl.innerHTML = "";
      hand.forEach((card, index) => {
        const cardEl = document.createElement("div");
        cardEl.className = "card";
        if (card.type === "number") {
          cardEl.classList.add(card.color);
          cardEl.textContent = card.value;
          const label = document.createElement("div");
          label.className = "card-label";
          label.textContent = COLOR_LABEL[card.color];
          cardEl.appendChild(label);
        } else {
          cardEl.classList.add("special", card.type);
          if (card.type === "sun") {
            cardEl.textContent = "â˜€";
          } else if (card.type === "moon") {
            cardEl.textContent = "ğŸŒ™";
          } else if (card.type === "star") {
            cardEl.textContent = "â­";
          }
        }

        cardEl.addEventListener("click", () => {
          onHandCardClick(index);
        });

        handEl.appendChild(cardEl);
      });

      if (hand.length === 0) {
        const hint = document.createElement("div");
        hint.className = "hint";
        hint.textContent = "ğŸ´ â€˜3ì¥ ë“œë¡œìš°â€™ë¥¼ ëˆŒëŸ¬ ìƒˆ ì¹´ë“œë¥¼ ë°›ìœ¼ì„¸ìš”.";
        handEl.appendChild(hint);
      }
    }

    function renderSpecials() {
      specialsEl.innerHTML = "";
      specials.forEach((s, i) => {
        const cardEl = document.createElement("div");
        cardEl.className = "card small special " + s.type;
        const label = document.createElement("div");
        label.className = "card-label";

        if (s.type === "sun") {
          cardEl.textContent = "â˜€";
          label.textContent = "ì ìˆ˜ x2";
        } else if (s.type === "moon") {
          cardEl.textContent = "ğŸŒ™";
          label.textContent = "ë²„ë¦° ì¹´ë“œ";
        } else if (s.type === "star") {
          cardEl.textContent = "â­";
          label.textContent = "ìƒ‰ ë³€ê²½";
        }
        cardEl.appendChild(label);

        // íŠœí† ë¦¬ì–¼ì—ì„œëŠ” íŠ¹ìˆ˜ ì¹´ë“œ ë¹„í™œì„±í™” (ëª¨ì–‘ë§Œ ë³´ì—¬ì¤Œ)
        if (mode === "tutorial" || s.used) {
          cardEl.classList.add("disabled");
        } else {
          cardEl.addEventListener("click", () => onSpecialClick(i));
        }

        specialsEl.appendChild(cardEl);
      });

      if (mode === "tutorial") {
        const hint = document.createElement("div");
        hint.className = "hint";
        hint.textContent = "íŠœí† ë¦¬ì–¼ì—ì„œëŠ” í•´/ë‹¬/ë³„ ì¹´ë“œëŠ” êµ¬ê²½ë§Œ í•˜ê³ , ë³¸ ê²Œì„ì—ì„œ ì‹¤ì œë¡œ ì‚¬ìš©í•´ë´ìš”.";
        specialsEl.appendChild(hint);
      }
    }

    function renderDiscard() {
      discardEl.innerHTML = "";
      discardPile.slice(-9).forEach(card => {
        const cardEl = document.createElement("div");
        cardEl.className = "card small " + (card.type === "number" ? card.color : "");
        if (card.type === "number") {
          cardEl.textContent = card.value;
          const label = document.createElement("div");
          label.className = "card-label";
          label.textContent = COLOR_LABEL[card.color];
          cardEl.appendChild(label);
        } else {
          cardEl.textContent = "?";
        }
        cardEl.classList.add("disabled");
        discardEl.appendChild(cardEl);
      });
      if (discardPile.length === 0) {
        const hint = document.createElement("div");
        hint.className = "hint";
        hint.textContent = mode === "tutorial" ? "ì§€ê¸ˆì€ ì—°ìŠµ ì¤‘! í•„ìš” ì—†ëŠ” ì¹´ë“œëŠ” ìë™ìœ¼ë¡œ ì—¬ê¸°ì— ìŒ“ì…ë‹ˆë‹¤." : "ì•„ì§ ë²„ë ¤ì§„ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.";
        discardEl.appendChild(hint);
      }
    }

    // ---- ì ìˆ˜ ê³„ì‚° ----
    function calculateFieldScore() {
      if (field.length === 0) return { total: 0, base: 0, bonuses: [], multiplier: 1 };

      const nums = field.filter(c => c.type === "number");
      const base = nums.reduce((sum, c) => sum + c.value, 0);

      const colors = nums.map(c => c.color);
      const values = nums.map(c => c.value).sort((a, b) => a - b);

      const bonuses = [];
      let score = base;

      // ë‹¨ìƒ‰ 5ì¥
      if (nums.length === 5 && colors.every(c => c === colors[0])) {
        score += 20;
        bonuses.push("ë‹¨ìƒ‰(5ì¥ ê°™ì€ ìƒ‰) +20");
      }

      // ì—°ì† 5ì¥
      if (nums.length === 5) {
        let isSeq = true;
        for (let i = 1; i < values.length; i++) {
          if (values[i] !== values[i - 1] + 1) {
            isSeq = false;
            break;
          }
        }
        if (isSeq) {
          score += 15;
          bonuses.push("ì—°ì† ìˆ«ì(ìŠ¤íŠ¸ë ˆì´íŠ¸) +15");
        }
      }

      // ìƒ‰ ëª¨ë‘ ë‹¤ë¦„
      const uniqueColors = new Set(colors);
      if (nums.length === 5 && uniqueColors.size === 3) {
        score += 12;
        bonuses.push("ëª¨ë‘ ë‹¤ë¥¸ ìƒ‰(ë¬´ì§€ê°œ) +12");
      }

      // ìˆ«ì í•© 35 ì´ìƒ
      if (base >= 35) {
        score += 10;
        bonuses.push("ìˆ«ì ì´í•© 35+ +10");
      }

      let multiplier = (sunUsedThisRound && mode === "normal") ? 2 : 1;
      const total = score * multiplier;

      return { total, base, bonuses, multiplier };
    }

    // ---- ì¸í„°ë™ì…˜ ----
    function onHandCardClick(index) {
      const card = hand[index];

      if (awaitingMoonSelection) {
        log("ë¨¼ì € Moon íš¨ê³¼ë¡œ ë²„ë¦° ì¹´ë“œì—ì„œ ì„ íƒí•˜ì„¸ìš”.", "warn");
        return;
      }
      if (awaitingStarFieldSelection || awaitingStarColorSelection !== null) {
        log("Star ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤. ìƒ‰ ë³€ê²½ì„ ë¨¼ì € ì™„ë£Œí•˜ì„¸ìš”.", "warn");
        return;
      }

      if (card.type === "number") {
        if (field.length >= 5) {
          log("í•„ë“œê°€ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤. ìƒˆ ë¼ìš´ë“œë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”.", "warn");
          return;
        }
        field.push(card);
        // ë‚˜ë¨¸ì§€ëŠ” discard
        hand.forEach((c, i) => {
          if (i !== index) discardPile.push(c);
        });
        hand = [];
        if (mode === "tutorial") {
          log(`í•„ë“œì— ${COLOR_LABEL[card.color]} ${card.value} ì„(ë¥¼) ì˜¬ë ¸ì–´ìš”. ì´ë ‡ê²Œ 5ì¥ê¹Œì§€ ì±„ì›Œë³´ë©´ ë©ë‹ˆë‹¤.`, "system");
        } else {
          log(`í•„ë“œì— ${COLOR_LABEL[card.color]} ${card.value} ì„(ë¥¼) ì˜¬ë ¸ìŠµë‹ˆë‹¤.`, "system");
        }

        render();

        if (field.length === 5) {
          // íŠœí† ë¦¬ì–¼ì—ì„œëŠ” ì ìˆ˜ ìƒê´€ ì—†ì´ "ì™„ë£Œ"
          if (mode === "tutorial") {
            endTutorial();
          } else {
            endRound();
          }
        } else if (mode === "tutorial") {
          log(`ì¢‹ì•„ìš”! ì´ì œ ë‹¤ì‹œ '3ì¥ ë“œë¡œìš°'ë¥¼ ëˆŒëŸ¬ ë‹¤ìŒ ì¹´ë“œë¥¼ ê³¨ë¼ë³´ì„¸ìš”. (í˜„ì¬ ${field.length}/5ì¥)`, "system");
        }
      }
    }

    function onSpecialClick(index) {
      if (mode === "tutorial") {
        log("íŠœí† ë¦¬ì–¼ì—ì„œëŠ” íŠ¹ìˆ˜ ì¹´ë“œë¥¼ êµ¬ê²½ë§Œ í•©ë‹ˆë‹¤. ë³¸ ê²Œì„ì—ì„œ ì‚¬ìš©í•´ë³´ì„¸ìš”!", "system");
        return;
      }

      const s = specials[index];
      if (s.used) return;

      if (s.type === "sun") {
        if (sunUsedThisRound) {
          log("ì´ë²ˆ ë¼ìš´ë“œì—ì„œ ì´ë¯¸ Sunì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.", "warn");
          return;
        }
        sunUsedThisRound = true;
        s.used = true;
        log("â˜€ Sun ì‚¬ìš©! ì´ë²ˆ ë¼ìš´ë“œ ìµœì¢… ì ìˆ˜ê°€ x2ê°€ ë©ë‹ˆë‹¤.", "system");
        render();
      } else if (s.type === "moon") {
        if (discardPile.length === 0) {
          log("ë²„ë ¤ì§„ ì¹´ë“œê°€ ì—†ì–´ì„œ Moonì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "warn");
          return;
        }
        awaitingMoonSelection = true;
        s.used = true;
        log("ğŸŒ™ Moon ì‚¬ìš©! ë²„ë ¤ì§„ ì¹´ë“œ ì¤‘ 1ì¥ì„ í´ë¦­í•´ì„œ ì†ìœ¼ë¡œ ê°€ì ¸ì˜¤ì„¸ìš”.", "system");
        showDiscardSelectionForMoon();
      } else if (s.type === "star") {
        if (field.length === 0) {
          log("í•„ë“œì— ì¹´ë“œê°€ ì—†ì–´ Starë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "warn");
          return;
        }
        awaitingStarFieldSelection = true;
        s.used = true;
        log("â­ Star ì‚¬ìš©! ìƒ‰ì„ ë°”ê¿€ í•„ë“œ ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.", "system");
        render();
      }
    }

    function showDiscardSelectionForMoon() {
      discardEl.innerHTML = "";
      discardPile.forEach((card, idx) => {
        const cardEl = document.createElement("div");
        cardEl.className = "card small " + (card.type === "number" ? card.color : "");
        if (card.type === "number") {
          cardEl.textContent = card.value;
          const label = document.createElement("div");
          label.className = "card-label";
          label.textContent = COLOR_LABEL[card.color];
          cardEl.appendChild(label);
        }
        cardEl.addEventListener("click", () => {
          if (!awaitingMoonSelection) return;
          awaitingMoonSelection = false;
          const chosen = discardPile.splice(idx, 1)[0];
          hand.push(chosen);
          log(`ğŸŒ™ Moonìœ¼ë¡œ ë²„ë¦° ì¹´ë“œì—ì„œ ${COLOR_LABEL[chosen.color]} ${chosen.value} ì„(ë¥¼) ë‹¤ì‹œ ì†ì— ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.`, "system");
          render();
        });
        discardEl.appendChild(cardEl);
      });
    }

    function showColorChoiceOverlay() {
      const choice = window.prompt("ìƒ‰ì„ ì„ íƒí•˜ì„¸ìš”: red / blue / green");
      if (!choice) {
        log("Star ì‚¬ìš©ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.", "warn");
        awaitingStarColorSelection = null;
        render();
        return;
      }
      const trimmed = choice.trim().toLowerCase();
      if (!["red", "blue", "green"].includes(trimmed)) {
        log("ìœ íš¨í•œ ìƒ‰ì´ ì•„ë‹™ë‹ˆë‹¤. Star ì‚¬ìš©ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.", "warn");
        awaitingStarColorSelection = null;
        render();
        return;
      }
      const idx = awaitingStarColorSelection;
      if (idx === null || field[idx].type !== "number") {
        log("ìƒ‰ì„ ë°”ê¿€ ìˆ˜ ì—†ëŠ” ì¹´ë“œì…ë‹ˆë‹¤.", "warn");
        awaitingStarColorSelection = null;
        render();
        return;
      }
      const beforeColor = field[idx].color;
      field[idx].color = trimmed;
      awaitingStarColorSelection = null;
      log(`â­ Star! ${COLOR_LABEL[beforeColor]} â†’ ${COLOR_LABEL[trimmed]} ë¡œ ìƒ‰ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, "system");
      render();
    }

    function endRound() {
      const result = calculateFieldScore();
      const breakdown = document.createElement("div");
      breakdown.className = "score-breakdown";

      const basePill = document.createElement("span");
      basePill.className = "pill";
      basePill.textContent = `ê¸°ë³¸ í•©ê³„ ${result.base}`;
      breakdown.appendChild(basePill);

      result.bonuses.forEach(b => {
        const pill = document.createElement("span");
        pill.className = "pill bonus";
        pill.textContent = b;
        breakdown.appendChild(pill);
      });

      if (result.multiplier > 1) {
        const pill = document.createElement("span");
        pill.className = "pill multiplier";
        pill.textContent = `SUN x${result.multiplier}`;
        breakdown.appendChild(pill);
      }

      logEl.prepend(breakdown);

      if (result.total >= targetScore) {
        log(`ë¼ìš´ë“œ í´ë¦¬ì–´! ì´ ì ìˆ˜ ${result.total} (ëª©í‘œ ${targetScore})`, "score");
      } else {
        log(`ì‹¤íŒ¨... ì´ ì ìˆ˜ ${result.total} (ëª©í‘œ ${targetScore})`, "warn");
      }

      setTimeout(() => {
        startNewRound(result.total >= targetScore);
      }, 400);
    }

    function endTutorial() {
      const result = calculateFieldScore();
      log(`ğŸ‰ íŠœí† ë¦¬ì–¼ ì™„ë£Œ! ì´ë²ˆì— ë§Œë“  íŒ¨í„´ì˜ ì´ ì ìˆ˜ëŠ” ${result.total}ì ì´ì—ìš”.`, "score");
      const breakdown = document.createElement("div");
      breakdown.className = "score-breakdown";
      const pill = document.createElement("span");
      pill.className = "pill";
      pill.textContent = `ì´ì œë¶€í„°ëŠ” ëª©í‘œ ì ìˆ˜ë¥¼ ë„˜ê¸°ëŠ” ê²Œ ëª©í‘œì…ë‹ˆë‹¤.`;
      breakdown.appendChild(pill);
      logEl.prepend(breakdown);

      setTimeout(() => {
        switchToNormalMode();
      }, 600);
    }

    function switchToNormalMode() {
      mode = "normal";
      round = 1;
      targetScore = TARGET_SCORE_BASE;
      field = [];
      hand = [];
      discardPile = [];
      sunUsedThisRound = false;
      awaitingMoonSelection = false;
      awaitingStarFieldSelection = false;
      awaitingStarColorSelection = null;
      specials = [
        { type: "sun", name: "Sun", used: false },
        { type: "moon", name: "Moon", used: false },
        { type: "star", name: "Star", used: false },
      ];
      log("ë³¸ ê²Œì„ì´ ì‹œì‘ë©ë‹ˆë‹¤! ë¼ìš´ë“œ 1ì˜ ëª©í‘œ ì ìˆ˜ëŠ” " + targetScore + "ì ì…ë‹ˆë‹¤.", "system");
      render();
    }

    function startNewRound(success) {
      field = [];
      hand = [];
      discardPile = [];
      sunUsedThisRound = false;
      awaitingMoonSelection = false;
      awaitingStarFieldSelection = false;
      awaitingStarColorSelection = null;

      if (success) {
        round += 1;
        targetScore = TARGET_SCORE_BASE + (round - 1) * 10; // ë¼ìš´ë“œë§ˆë‹¤ ëª©í‘œ ì ìˆ˜ +10
        log(`ë‹¤ìŒ ë¼ìš´ë“œë¡œ! ë¼ìš´ë“œ ${round}, ëª©í‘œ ì ìˆ˜ëŠ” ${targetScore} ì…ë‹ˆë‹¤.`, "system");
      } else {
        log("ê°™ì€ ë¼ìš´ë“œë¥¼ ë‹¤ì‹œ ë„ì „í•©ë‹ˆë‹¤.", "system");
      }

      specials = [
        { type: "sun", name: "Sun", used: false },
        { type: "moon", name: "Moon", used: false },
        { type: "star", name: "Star", used: false },
      ];

      render();
    }

    function drawThree() {
      if (hand.length > 0) {
        log("ì´ë¯¸ ì†íŒ¨ê°€ ìˆìŠµë‹ˆë‹¤. ë¨¼ì € ì†íŒ¨ì—ì„œ ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.", "warn");
        return;
      }
      if (field.length >= 5) {
        log("í•„ë“œê°€ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.", "warn");
        return;
      }

      if (mode === "tutorial") {
        const idx = Math.min(tutorialHands.length - 1, tutorialStep);
        hand = tutorialHands[idx].map(c => ({ ...c })); // ë³µì‚¬
        tutorialStep++;
        log("íŠœí† ë¦¬ì–¼: ìƒˆ ì¹´ë“œ 3ì¥ì„ ë“œë¡œìš°í–ˆìŠµë‹ˆë‹¤. ë§ˆìŒì— ë“œëŠ” ì¹´ë“œ 1ì¥ì„ í•„ë“œì— ì˜¬ë ¤ë³´ì„¸ìš”.", "system");
      } else {
        hand = createDeckSample(3);
        log("ìƒˆ ì¹´ë“œ 3ì¥ì„ ë“œë¡œìš°í–ˆìŠµë‹ˆë‹¤.", "system");
      }

      render();
    }

    function resetGame() {
      mode = "tutorial";
      tutorialStep = 0;
      round = 1;
      targetScore = TARGET_SCORE_BASE;
      field = [];
      hand = [];
      discardPile = [];
      sunUsedThisRound = false;
      awaitingMoonSelection = false;
      awaitingStarFieldSelection = false;
      awaitingStarColorSelection = null;
      specials = [
        { type: "sun", name: "Sun", used: false },
        { type: "moon", name: "Moon", used: false },
        { type: "star", name: "Star", used: false },
      ];
      log("ê²Œì„ì´ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ íŠœí† ë¦¬ì–¼ë¶€í„° ì‹œì‘í•´ë³¼ê²Œìš”.", "system");
      render();
    }

    // ---- ì´ë²¤íŠ¸ ë°”ì¸ë”© ----
    drawBtn.addEventListener("click", drawThree);
    resetBtn.addEventListener("click", resetGame);

    // ì´ˆê¸° ë Œë”
    render();
    log("íŠœí† ë¦¬ì–¼ ì‹œì‘! ğŸ´ â€˜3ì¥ ë“œë¡œìš°â€™ë¥¼ ëˆŒëŸ¬ ì²« íŒ¨ë¥¼ ë°›ì•„ë³´ì„¸ìš”.", "system");
  </script>
</body>
</html>
