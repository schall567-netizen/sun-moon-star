<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í•´ Â· ë‹¬ Â· ë³„ ì¹´ë“œê²Œì„</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #fdf6e3 0, #f0f4ff 40%, #e7ecf5 100%);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      color: #222;
    }
    .game-container {
      margin: 24px;
      max-width: 520px;
      width: 100%;
      background: #ffffffdd;
      backdrop-filter: blur(8px);
      border-radius: 18px;
      padding: 16px 16px 24px;
      box-shadow:
        0 18px 45px rgba(15, 23, 42, 0.18),
        0 0 0 1px rgba(148, 163, 184, 0.2);
      position: relative;
    }
    h1 {
      margin: 0 0 4px;
      font-size: 22px;
      letter-spacing: 0.04em;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: flex-start;
    }
    h1 span.logo {
      font-size: 18px;
      padding: 2px 10px;
      border-radius: 999px;
      background: linear-gradient(90deg, #f97316, #ec4899, #6366f1);
      color: white;
    }
    .subtitle {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .top-right-controls {
      position: absolute;
      right: 16px;
      top: 14px;
      display: flex;
      gap: 6px;
    }
    .btn-mini {
      border-radius: 999px;
      border: none;
      font-size: 11px;
      padding: 4px 10px;
      cursor: pointer;
      background: #e5e7eb;
      color: #111827;
    }
    .btn-mini.practice {
      background: #ecfdf5;
      color: #047857;
    }
    .status-bar {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin: 8px 0 6px;
      color: #4b5563;
      gap: 8px;
      flex-wrap: wrap;
    }
    .status-label {
      font-weight: 600;
      color: #111827;
    }
    .status-dim {
      opacity: 0.6;
    }
    .hearts {
      color: #ef4444;
      font-weight: 700;
    }
    .zone-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #6b7280;
      margin: 10px 4px 4px;
    }
    .card-row {
      display: flex;
      gap: 6px;
      min-height: 80px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }
    .card {
      min-width: 60px;
      min-height: 80px;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 6px;
      box-sizing: border-box;
      cursor: pointer;
      position: relative;
      background: #f9fafb;
      transition: transform 0.08s ease, box-shadow 0.08s ease, border-color 0.08s ease;
      font-size: 20px;
      font-weight: 700;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.18);
    }
    .card.small {
      min-width: 46px;
      min-height: 64px;
      font-size: 16px;
    }
    .card.disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
      transform: none;
    }
    .card-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-top: 2px;
      color: #4b5563;
    }
    .card.red {
      border-color: rgba(248, 113, 113, 0.8);
      background: radial-gradient(circle at top, #fee2e2, #fef2f2);
      color: #991b1b;
    }
    .card.blue {
      border-color: rgba(96, 165, 250, 0.8);
      background: radial-gradient(circle at top, #dbeafe, #eff6ff);
      color: #1d4ed8;
    }
    .card.green {
      border-color: rgba(52, 211, 153, 0.8);
      background: radial-gradient(circle at top, #d1fae5, #ecfdf5);
      color: #047857;
    }
    .card.special.sun {
      background: radial-gradient(circle at top, #facc15, #f97316);
      color: #fefce8;
      border-color: rgba(202, 138, 4, 0.9);
      font-size: 22px;
    }
    .card.special.moon {
      background: radial-gradient(circle at top, #0f172a, #1f2937);
      color: #e5e7eb;
      border-color: rgba(148, 163, 184, 0.9);
      font-size: 22px;
    }
    .card.special.star {
      background: radial-gradient(circle at top, #312e81, #1f2937);
      color: #facc15;
      border-color: rgba(129, 140, 248, 0.9);
      font-size: 22px;
    }
    .controls {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(90deg, #6366f1, #0ea5e9);
      color: white;
      box-shadow: 0 6px 18px rgba(37, 99, 235, 0.35);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, filter 0.08s ease;
    }
    button:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 8px 24px rgba(37, 99, 235, 0.45);
    }
    button:disabled {
      opacity: 0.35;
      cursor: default;
      box-shadow: none;
      transform: none;
      filter: none;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
      box-shadow: none;
    }
    .btn-secondary:hover {
      box-shadow: 0 4px 12px rgba(148, 163, 184, 0.6);
    }
    .log {
      margin-top: 12px;
      font-size: 12px;
      padding: 8px 10px;
      background: #f9fafb;
      border-radius: 12px;
      border: 1px solid rgba(209, 213, 219, 0.8);
      max-height: 160px;
      overflow-y: auto;
      line-height: 1.5;
    }
    .log-line { margin-bottom: 3px; }
    .log-line span.tag {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-right: 4px;
      color: #6b7280;
    }
    .tag-system { color: #6366f1; }
    .tag-score { color: #0f766e; }
    .tag-warn { color: #b91c1c; }
    .score-breakdown {
      font-size: 11px;
      margin-top: 4px;
      color: #4b5563;
    }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      background: #e5e7eb;
      margin-right: 4px;
      margin-bottom: 2px;
    }
    .pill.bonus { background: #ecfdf5; color: #047857; }
    .pill.multiplier { background: #fef9c3; color: #92400e; }
    .hint {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
      text-align: center;
    }
    .hint-strong { font-weight: 600; color: #374151; }
  </style>
</head>
<body>
  <div class="game-container">
    <div class="top-right-controls">
      <button id="practiceEnterBtn" class="btn-mini">ì—°ìŠµëª¨ë“œ</button>
      <button id="practiceExitBtn" class="btn-mini practice" style="display:none;">âœ• ì—°ìŠµëª¨ë“œ ë‚˜ê°€ê¸°</button>
    </div>

    <h1>
      <span class="logo">â˜€ ğŸŒ™ â­</span>
      í•´ Â· ë‹¬ Â· ë³„
    </h1>
    <div class="subtitle">ìˆ«ìÂ·ìƒ‰ ì‹œë„ˆì§€ë¡œ íŒ¨í„´ì„ ë§ì¶”ê³ , ë¼ìš´ë“œë¥¼ ì˜¬ë¼ê°€ëŠ” ì†”ë¦¬í…Œì–´ ì¹´ë“œ ê²Œì„.</div>

    <div class="status-bar">
      <div><span class="status-label">ëª¨ë“œ:</span> <span id="modeText">ë³¸ ê²Œì„</span></div>
      <div><span class="status-label">ë¼ìš´ë“œ:</span> <span id="round">1</span></div>
      <div><span class="status-label">ëª©í‘œ ì ìˆ˜:</span> <span id="targetScore">40</span></div>
      <div><span class="status-label">í˜„ì¬ ì ìˆ˜:</span> <span id="currentScore">0</span></div>
      <div><span class="status-label">í•˜íŠ¸:</span> <span id="hearts" class="hearts">â™¥â™¥â™¥</span></div>
    </div>

    <div class="zone-title">í•„ë“œ (5ì¥ ëª¨ì´ë©´ ìë™ ì±„ì )</div>
    <div id="field" class="card-row"></div>

    <div class="zone-title">í˜„ì¬ ì„ íƒ ê°€ëŠ¥í•œ ì¹´ë“œ (3ì¥)</div>
    <div id="hand" class="card-row"></div>

    <div class="zone-title">íŠ¹ìˆ˜ ì¹´ë“œ</div>
    <div id="specials" class="card-row"></div>

    <div class="controls">
      <button id="drawBtn">ğŸ´ 3ì¥ ë“œë¡œìš°</button>
      <button id="resetBtn" class="btn-secondary">ğŸ”„ ì „ì²´ ë¦¬ì…‹</button>
    </div>
    <div class="hint">
      <span class="hint-strong">TIP.</span> ì—°ìŠµì€ ì˜¤ë¥¸ìª½ ìœ„ <b>ì—°ìŠµëª¨ë“œ</b> ë²„íŠ¼ìœ¼ë¡œ, ë³¸ ê²Œì„ì€ í•˜íŠ¸ 3ê°œë¡œ ì‹œì‘í•´ ë¼ìš´ë“œë¥¼ ê³„ì† ì˜¬ë ¤ë³´ì„¸ìš”.
    </div>

    <div class="zone-title">ë²„ë ¤ì§„ ì¹´ë“œ</div>
    <div id="discard" class="card-row"></div>

    <div class="log" id="log"></div>
  </div>

  <script>
    // ---- ìƒìˆ˜ & ìƒíƒœ ----
    const COLORS = ["red", "blue", "green"];
    const COLOR_LABEL = { red: "RED", blue: "BLUE", green: "GREEN" };
    const TARGET_SCORE_BASE = 40;

    // mode: "normal" | "practice"
    let mode = "normal";

    let round = 1;
    let hearts = 3;
    let field = [];
    let hand = [];
    let discardPile = [];
    let specials = [
      { type: "sun", used: false },
      { type: "moon", used: false },
      { type: "star", used: false }
    ];

    let sunUsedThisRound = false;
    let awaitingMoonSelection = false;
    let awaitingStarFieldSelection = false;
    let awaitingStarColorSelection = null;
    let drawsThisRound = 0;

    const fieldEl = document.getElementById("field");
    const handEl = document.getElementById("hand");
    const specialsEl = document.getElementById("specials");
    const discardEl = document.getElementById("discard");
    const drawBtn = document.getElementById("drawBtn");
    const resetBtn = document.getElementById("resetBtn");
    const roundEl = document.getElementById("round");
    const targetScoreEl = document.getElementById("targetScore");
    const currentScoreEl = document.getElementById("currentScore");
    const heartsEl = document.getElementById("hearts");
    const logEl = document.getElementById("log");
    const modeTextEl = document.getElementById("modeText");
    const practiceEnterBtn = document.getElementById("practiceEnterBtn");
    const practiceExitBtn = document.getElementById("practiceExitBtn");

    // ì—°ìŠµëª¨ë“œìš© ê³ ì • íŒ¨í„´
    const practiceHands = [
      [
        { type: "number", value: 3, color: "red" },
        { type: "number", value: 5, color: "blue" },
        { type: "number", value: 7, color: "green" },
      ],
      [
        { type: "number", value: 2, color: "red" },
        { type: "number", value: 4, color: "red" },
        { type: "number", value: 9, color: "blue" },
      ],
      [
        { type: "number", value: 6, color: "green" },
        { type: "number", value: 8, color: "green" },
        { type: "number", value: 1, color: "blue" },
      ]
    ];
    let practiceStep = 0;

    function getRoundConfig(r) {
      let cfg = {
        target: TARGET_SCORE_BASE,
        maxDraws: Infinity,
        requireCombo: false
      };
      if (r === 1) {
        cfg.target = 40;
        cfg.maxDraws = Infinity;
        cfg.requireCombo = false;
      } else if (r === 2) {
        cfg.target = 55;
        cfg.maxDraws = 7;
        cfg.requireCombo = false;
      } else if (r === 3) {
        cfg.target = 65;
        cfg.maxDraws = 7;
        cfg.requireCombo = true;
      } else if (r === 4) {
        cfg.target = 75;
        cfg.maxDraws = 6;
        cfg.requireCombo = true;
      } else {
        cfg.target = 80 + (r - 4) * 10;
        cfg.maxDraws = 6;
        cfg.requireCombo = true;
      }
      return cfg;
    }

    // ---- ìœ í‹¸ ----
    function log(message, tag = "system") {
      const div = document.createElement("div");
      div.className = "log-line";
      const span = document.createElement("span");
      span.className = "tag " + (tag === "score" ? "tag-score" : tag === "warn" ? "tag-warn" : "tag-system");
      span.textContent = tag.toUpperCase();
      div.appendChild(span);
      div.appendChild(document.createTextNode(message));
      logEl.prepend(div);
    }

    function createNumberCard() {
      const value = Math.floor(Math.random() * 9) + 1;
      const color = COLORS[Math.floor(Math.random() * COLORS.length)];
      return { type: "number", value, color };
    }

    function createDeckSample(n) {
      const arr = [];
      for (let i = 0; i < n; i++) arr.push(createNumberCard());
      return arr;
    }

    // ---- ë Œë”ë§ ----
    function render() {
      renderField();
      renderHand();
      renderSpecials();
      renderDiscard();

      const scoreResult = calculateFieldScore();
      currentScoreEl.textContent = scoreResult.total;

      if (mode === "practice") {
        modeTextEl.textContent = "ì—°ìŠµ ëª¨ë“œ";
        roundEl.textContent = "-";
        targetScoreEl.textContent = "-";
        targetScoreEl.classList.add("status-dim");
        heartsEl.textContent = "â™¥â™¥â™¥";
        heartsEl.classList.add("status-dim");
      } else {
        const cfg = getRoundConfig(round);
        modeTextEl.textContent = "ë³¸ ê²Œì„";
        roundEl.textContent = round;
        targetScoreEl.textContent = cfg.target;
        targetScoreEl.classList.remove("status-dim");
        heartsEl.textContent = "â™¥".repeat(hearts);
        heartsEl.classList.remove("status-dim");
      }
    }

    function renderField() {
      fieldEl.innerHTML = "";
      field.forEach((card, index) => {
        const cardEl = document.createElement("div");
        cardEl.className = "card " + (card.type === "number" ? card.color : "");
        if (card.type === "number") {
          cardEl.textContent = card.value;
          const label = document.createElement("div");
          label.className = "card-label";
          label.textContent = COLOR_LABEL[card.color];
          cardEl.appendChild(label);
        } else {
          cardEl.textContent = "?";
        }
        fieldEl.appendChild(cardEl);
      });

      for (let i = field.length; i < 5; i++) {
        const empty = document.createElement("div");
        empty.className = "card small disabled";
        empty.style.borderStyle = "dashed";
        empty.style.background = "transparent";
        empty.style.boxShadow = "none";
        empty.textContent = "+";
        fieldEl.appendChild(empty);
      }
    }

    function renderHand() {
      handEl.innerHTML = "";
      hand.forEach((card, index) => {
        const cardEl = document.createElement("div");
        cardEl.className = "card";
        if (card.type === "number") {
          cardEl.classList.add(card.color);
          cardEl.textContent = card.value;
          const label = document.createElement("div");
          label.className = "card-label";
          label.textContent = COLOR_LABEL[card.color];
          cardEl.appendChild(label);
        }
        cardEl.addEventListener("click", () => onHandCardClick(index));
        handEl.appendChild(cardEl);
      });

      if (hand.length === 0) {
        const hint = document.createElement("div");
        hint.className = "hint";
        hint.textContent = "ğŸ´ â€˜3ì¥ ë“œë¡œìš°â€™ë¥¼ ëˆŒëŸ¬ ìƒˆ ì¹´ë“œë¥¼ ë°›ìœ¼ì„¸ìš”.";
        handEl.appendChild(hint);
      }
    }

    function renderSpecials() {
      specialsEl.innerHTML = "";
      specials.forEach((s, i) => {
        const cardEl = document.createElement("div");
        cardEl.className = "card small special " + s.type;
        const label = document.createElement("div");
        label.className = "card-label";

        if (s.type === "sun") {
          cardEl.textContent = "â˜€";
          label.textContent = "ì ìˆ˜ x2";
        } else if (s.type === "moon") {
          cardEl.textContent = "ğŸŒ™";
          label.textContent = "ë²„ë¦° ì¹´ë“œ";
        } else if (s.type === "star") {
          cardEl.textContent = "â­";
          label.textContent = "ìƒ‰ ë³€ê²½";
        }
        cardEl.appendChild(label);

        if (mode === "practice" || s.used) {
          cardEl.classList.add("disabled");
        } else {
          cardEl.addEventListener("click", () => onSpecialClick(i));
        }

        specialsEl.appendChild(cardEl);
      });

      if (mode === "practice") {
        const hint = document.createElement("div");
        hint.className = "hint";
        hint.textContent = "ì—°ìŠµëª¨ë“œì—ì„œëŠ” í•´/ë‹¬/ë³„ì€ êµ¬ê²½ë§Œ í•˜ê³ , ë³¸ ê²Œì„ì—ì„œ ì‹¤ì œë¡œ ì‚¬ìš©í•´ë´ìš”.";
        specialsEl.appendChild(hint);
      }
    }

    function renderDiscard() {
      discardEl.innerHTML = "";
      discardPile.slice(-9).forEach(card => {
        const cardEl = document.createElement("div");
        cardEl.className = "card small " + (card.type === "number" ? card.color : "");
        if (card.type === "number") {
          cardEl.textContent = card.value;
          const label = document.createElement("div");
          label.className = "card-label";
          label.textContent = COLOR_LABEL[card.color];
          cardEl.appendChild(label);
        }
        cardEl.classList.add("disabled");
        discardEl.appendChild(cardEl);
      });
      if (discardPile.length === 0) {
        const hint = document.createElement("div");
        hint.className = "hint";
        hint.textContent = mode === "practice"
          ? "ì—°ìŠµ ì¤‘! í•„ìš” ì—†ëŠ” ì¹´ë“œëŠ” ìë™ìœ¼ë¡œ ì—¬ê¸°ì— ìŒ“ì…ë‹ˆë‹¤."
          : "ì•„ì§ ë²„ë ¤ì§„ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.";
        discardEl.appendChild(hint);
      }
    }

    // ---- ì ìˆ˜/ì‹œë„ˆì§€ ê³„ì‚° ----
    function calculateFieldScore() {
      if (field.length === 0) return { total: 0, base: 0, bonuses: [], hadCombo: false };

      const nums = field.filter(c => c.type === "number");
      const base = nums.reduce((sum, c) => sum + c.value, 0);
      const colors = nums.map(c => c.color);
      const values = nums.map(c => c.value).sort((a, b) => a - b);

      const bonuses = [];
      let score = base;
      let hadCombo = false;

      // 1) ê¸°ì¡´ íŒ¨í„´ë“¤
      if (nums.length === 5 && colors.every(c => c === colors[0])) {
        score += 20;
        bonuses.push("ë‹¨ìƒ‰ 5ì¥(Flush) +20");
        hadCombo = true;
      }

      if (nums.length === 5) {
        let isSeq = true;
        for (let i = 1; i < values.length; i++) {
          if (values[i] !== values[i - 1] + 1) {
            isSeq = false;
            break;
          }
        }
        if (isSeq) {
          score += 15;
          bonuses.push("ì—°ì† 5ì¥(Straight) +15");
          hadCombo = true;
        }
      }

      const uniqueColors = new Set(colors);
      if (nums.length === 5 && uniqueColors.size === 3) {
        score += 12;
        bonuses.push("ì„¸ ìƒ‰ ëª¨ë‘ ë‹¤ë¦„(ë¬´ì§€ê°œ) +12");
        hadCombo = true;
      }

      if (base >= 35) {
        score += 10;
        bonuses.push("ìˆ«ì í•© 35+ +10");
        hadCombo = true;
      }

      // 2) ê°™ì€ ìˆ«ì ì„¸íŠ¸
      const countByValue = {};
      nums.forEach(c => {
        countByValue[c.value] = (countByValue[c.value] || 0) + 1;
      });
      Object.entries(countByValue).forEach(([val, cnt]) => {
        if (cnt >= 2) {
          let add = 0;
          let name = "";
          if (cnt === 2) { add = 5; name = "í˜ì–´"; }
          else if (cnt === 3) { add = 12; name = "íŠ¸ë¦¬í”Œ"; }
          else if (cnt === 4) { add = 20; name = "í¬ì¹´ë“œ"; }
          else if (cnt === 5) { add = 35; name = "íŒŒì´ë¸Œì¹´ë“œ"; }
          score += add;
          bonuses.push(`ê°™ì€ ìˆ«ì ${cnt}ì¥(${name}) +${add}`);
          hadCombo = true;
        }
      });

      // 3) ì¸ì ‘ ê°™ì€ ìƒ‰ ì²´ì¸
      let chainLen = 1;
      for (let i = 1; i < nums.length; i++) {
        if (nums[i].color === nums[i - 1].color) {
          chainLen++;
        } else {
          if (chainLen >= 2) {
            const add = (chainLen - 1) * 3;
            score += add;
            bonuses.push(`ê°™ì€ ìƒ‰ ì—°ì† ${chainLen}ì¥ +${add}`);
            hadCombo = true;
          }
          chainLen = 1;
        }
      }
      if (chainLen >= 2) {
        const add = (chainLen - 1) * 3;
        score += add;
        bonuses.push(`ê°™ì€ ìƒ‰ ì—°ì† ${chainLen}ì¥ +${add}`);
        hadCombo = true;
      }

      // Sun ë°°ìˆ˜
      let multiplier = (sunUsedThisRound && mode === "normal") ? 2 : 1;
      const total = score * multiplier;
      if (multiplier > 1) {
        bonuses.push(`SUN íš¨ê³¼ë¡œ ì ìˆ˜ x${multiplier}`);
        hadCombo = true;
      }

      return { total, base, bonuses, hadCombo };
    }

    // ---- ì¸í„°ë™ì…˜ ----
    function onHandCardClick(index) {
      const card = hand[index];

      if (awaitingMoonSelection) {
        log("ë¨¼ì € Moon íš¨ê³¼ë¡œ ë²„ë¦° ì¹´ë“œì—ì„œ ì„ íƒí•˜ì„¸ìš”.", "warn");
        return;
      }
      if (awaitingStarFieldSelection || awaitingStarColorSelection !== null) {
        log("Star ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤. ìƒ‰ ë³€ê²½ì„ ë¨¼ì € ì™„ë£Œí•˜ì„¸ìš”.", "warn");
        return;
      }

      if (card.type === "number") {
        if (field.length >= 5) {
          log("í•„ë“œê°€ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.", "warn");
          return;
        }
        field.push(card);
        hand.forEach((c, i) => { if (i !== index) discardPile.push(c); });
        hand = [];

        log(`í•„ë“œì— ${COLOR_LABEL[card.color]} ${card.value} ì„(ë¥¼) ì˜¬ë ¸ìŠµë‹ˆë‹¤.`, "system");
        render();

        if (field.length === 5) {
          if (mode === "practice") {
            finishPracticeHand();
          } else {
            endRound();
          }
        }
      }
    }

    function onSpecialClick(index) {
      if (mode === "practice") {
        log("ì—°ìŠµëª¨ë“œì—ì„œëŠ” íŠ¹ìˆ˜ ì¹´ë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "system");
        return;
      }

      const s = specials[index];
      if (s.used) return;

      if (s.type === "sun") {
        if (sunUsedThisRound) {
          log("ì´ë²ˆ ë¼ìš´ë“œì—ì„œ ì´ë¯¸ Sunì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.", "warn");
          return;
        }
        sunUsedThisRound = true;
        s.used = true;
        log("â˜€ Sun ì‚¬ìš©! ì´ë²ˆ ë¼ìš´ë“œ ìµœì¢… ì ìˆ˜ê°€ x2ê°€ ë©ë‹ˆë‹¤.", "system");
        render();
      } else if (s.type === "moon") {
        if (discardPile.length === 0) {
          log("ë²„ë ¤ì§„ ì¹´ë“œê°€ ì—†ì–´ì„œ Moonì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "warn");
          return;
        }
        awaitingMoonSelection = true;
        s.used = true;
        log("ğŸŒ™ Moon ì‚¬ìš©! ë²„ë ¤ì§„ ì¹´ë“œ ì¤‘ 1ì¥ì„ í´ë¦­í•´ì„œ ì†ìœ¼ë¡œ ê°€ì ¸ì˜¤ì„¸ìš”.", "system");
        showDiscardSelectionForMoon();
      } else if (s.type === "star") {
        if (field.length === 0) {
          log("í•„ë“œì— ì¹´ë“œê°€ ì—†ì–´ Starë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "warn");
          return;
        }
        awaitingStarFieldSelection = true;
        s.used = true;
        log("â­ Star ì‚¬ìš©! ìƒ‰ì„ ë°”ê¿€ í•„ë“œ ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.", "system");
        render();
      }
    }

    function showDiscardSelectionForMoon() {
      discardEl.innerHTML = "";
      discardPile.forEach((card, idx) => {
        const cardEl = document.createElement("div");
        cardEl.className = "card small " + (card.type === "number" ? card.color : "");
        if (card.type === "number") {
          cardEl.textContent = card.value;
          const label = document.createElement("div");
          label.className = "card-label";
          label.textContent = COLOR_LABEL[card.color];
          cardEl.appendChild(label);
        }
        cardEl.addEventListener("click", () => {
          if (!awaitingMoonSelection) return;
          awaitingMoonSelection = false;
          const chosen = discardPile.splice(idx, 1)[0];
          hand.push(chosen);
          log(`ğŸŒ™ Moonìœ¼ë¡œ ${COLOR_LABEL[chosen.color]} ${chosen.value} ì„(ë¥¼) ë‹¤ì‹œ ì†ì— ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.`, "system");
          render();
        });
        discardEl.appendChild(cardEl);
      });
    }

    function showColorChoiceOverlay() {
      const choice = window.prompt("ìƒ‰ì„ ì„ íƒí•˜ì„¸ìš”: red / blue / green");
      if (!choice) {
        log("Star ì‚¬ìš©ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.", "warn");
        awaitingStarColorSelection = null;
        render();
        return;
      }
      const trimmed = choice.trim().toLowerCase();
      if (!["red", "blue", "green"].includes(trimmed)) {
        log("ìœ íš¨í•œ ìƒ‰ì´ ì•„ë‹™ë‹ˆë‹¤. Star ì‚¬ìš©ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.", "warn");
        awaitingStarColorSelection = null;
        render();
        return;
      }
      const idx = awaitingStarColorSelection;
      if (idx === null || field[idx].type !== "number") {
        log("ìƒ‰ì„ ë°”ê¿€ ìˆ˜ ì—†ëŠ” ì¹´ë“œì…ë‹ˆë‹¤.", "warn");
        awaitingStarColorSelection = null;
        render();
        return;
      }
      const beforeColor = field[idx].color;
      field[idx].color = trimmed;
      awaitingStarColorSelection = null;
      log(`â­ Star! ${COLOR_LABEL[beforeColor]} â†’ ${COLOR_LABEL[trimmed]} ë¡œ ìƒ‰ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, "system");
      render();
    }

    // ---- ë¼ìš´ë“œ ì¢…ë£Œ / ìŠ¹ë¶€ ----
    function endRound() {
      const cfg = getRoundConfig(round);
      const result = calculateFieldScore();

      const breakdown = document.createElement("div");
      breakdown.className = "score-breakdown";
      const basePill = document.createElement("span");
      basePill.className = "pill";
      basePill.textContent = `ê¸°ë³¸ í•©ê³„ ${result.base}`;
      breakdown.appendChild(basePill);
      result.bonuses.forEach(b => {
        const pill = document.createElement("span");
        pill.className = "pill bonus";
        pill.textContent = b;
        breakdown.appendChild(pill);
      });
      logEl.prepend(breakdown);

      let success = false;
      if (cfg.requireCombo && !result.hadCombo) {
        log("ì´ ë¼ìš´ë“œëŠ” ìµœì†Œ 1ê°œì˜ íŒ¨í„´/ì‹œë„ˆì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤!", "warn");
        success = false;
      } else if (result.total >= cfg.target) {
        log(`ë¼ìš´ë“œ í´ë¦¬ì–´! ì´ ì ìˆ˜ ${result.total} (ëª©í‘œ ${cfg.target})`, "score");
        success = true;
      } else {
        log(`ì‹¤íŒ¨... ì´ ì ìˆ˜ ${result.total} (ëª©í‘œ ${cfg.target})`, "warn");
        success = false;
      }

      if (!success) {
        hearts -= 1;
        log(`í•˜íŠ¸ë¥¼ 1ê°œ ìƒì—ˆìŠµë‹ˆë‹¤. (ë‚¨ì€ í•˜íŠ¸: ${hearts})`, "warn");
        if (hearts <= 0) {
          log("ğŸ’€ í•˜íŠ¸ê°€ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤. ê²Œì„ ì˜¤ë²„!", "warn");
          render();
          return;
        }
      }

      setTimeout(() => startNewRound(success), 400);
    }

    function finishPracticeHand() {
      const result = calculateFieldScore();
      const breakdown = document.createElement("div");
      breakdown.className = "score-breakdown";
      const basePill = document.createElement("span");
      basePill.className = "pill";
      basePill.textContent = `ì—°ìŠµ í•©ê³„ ${result.base}`;
      breakdown.appendChild(basePill);
      result.bonuses.forEach(b => {
        const pill = document.createElement("span");
        pill.className = "pill bonus";
        pill.textContent = b;
        breakdown.appendChild(pill);
      });
      logEl.prepend(breakdown);
      log(`ì—°ìŠµëª¨ë“œ íŒ¨ ì™„ì„±! ì´ ì ìˆ˜ ${result.total}ì ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ë³¼ê¹Œìš”?`, "score");

      // ì—°ìŠµì€ ê·¸ëƒ¥ ì´ˆê¸°í™”
      field = [];
      hand = [];
      discardPile = [];
      sunUsedThisRound = false;
      drawsThisRound = 0;
      render();
    }

    function startNewRound(success) {
      field = [];
      hand = [];
      discardPile = [];
      sunUsedThisRound = false;
      awaitingMoonSelection = false;
      awaitingStarFieldSelection = false;
      awaitingStarColorSelection = null;
      drawsThisRound = 0;

      if (success) {
        round += 1;
        const cfg = getRoundConfig(round);
        log(`ë‹¤ìŒ ë¼ìš´ë“œë¡œ! ë¼ìš´ë“œ ${round}, ëª©í‘œ ì ìˆ˜ ${cfg.target}`, "system");
        if (cfg.maxDraws !== Infinity) {
          log(`ì´ ë¼ìš´ë“œì˜ ë“œë¡œìš° ì œí•œ: ${cfg.maxDraws}ë²ˆ`, "system");
        }
        if (cfg.requireCombo) {
          log("ì´ ë¼ìš´ë“œëŠ” íŒ¨í„´/ì‹œë„ˆì§€(ì„¸íŠ¸, ì—°ì†, ë‹¨ìƒ‰ ë“±) ìµœì†Œ 1ê°œê°€ í•„ìˆ˜ì…ë‹ˆë‹¤.", "system");
        }
      } else {
        const cfg = getRoundConfig(round);
        log("ê°™ì€ ë¼ìš´ë“œë¥¼ ë‹¤ì‹œ ë„ì „í•©ë‹ˆë‹¤.", "system");
        if (cfg.maxDraws !== Infinity) {
          log(`ì´ ë¼ìš´ë“œì˜ ë“œë¡œìš° ì œí•œ: ${cfg.maxDraws}ë²ˆ`, "system");
        }
      }

      specials = [
        { type: "sun", used: false },
        { type: "moon", used: false },
        { type: "star", used: false }
      ];

      render();
    }

    // ---- ë“œë¡œìš°/ë¦¬ì…‹/ì—°ìŠµëª¨ë“œ ----
    function drawThree() {
      if (hand.length > 0) {
        log("ì´ë¯¸ ì†íŒ¨ê°€ ìˆìŠµë‹ˆë‹¤. ë¨¼ì € ì†íŒ¨ì—ì„œ ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.", "warn");
        return;
      }
      if (field.length >= 5) {
        log("í•„ë“œê°€ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.", "warn");
        return;
      }

      if (mode === "practice") {
        const idx = Math.min(practiceHands.length - 1, practiceStep);
        hand = practiceHands[idx].map(c => ({ ...c }));
        practiceStep = (practiceStep + 1) % practiceHands.length;
        log("ì—°ìŠµëª¨ë“œ: ì¹´ë“œ 3ì¥ì„ ë“œë¡œìš°í–ˆìŠµë‹ˆë‹¤. ë§ˆìŒì— ë“œëŠ” ì¹´ë“œ 1ì¥ì„ í•„ë“œì— ì˜¬ë ¤ë³´ì„¸ìš”.", "system");
      } else {
        const cfg = getRoundConfig(round);
        if (drawsThisRound >= cfg.maxDraws) {
          log(`ì´ ë¼ìš´ë“œì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë“œë¡œìš°(${cfg.maxDraws})ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.`, "warn");
          return;
        }
        hand = createDeckSample(3);
        drawsThisRound++;
        log(`ìƒˆ ì¹´ë“œ 3ì¥ì„ ë“œë¡œìš°í–ˆìŠµë‹ˆë‹¤. (ì´ë²ˆ ë¼ìš´ë“œ ë“œë¡œìš° ${drawsThisRound}/${cfg.maxDraws === Infinity ? "âˆ" : cfg.maxDraws})`, "system");
      }

      render();
    }

    function resetGame() {
      mode = "normal";
      round = 1;
      hearts = 3;
      field = [];
      hand = [];
      discardPile = [];
      sunUsedThisRound = false;
      awaitingMoonSelection = false;
      awaitingStarFieldSelection = false;
      awaitingStarColorSelection = null;
      drawsThisRound = 0;
      specials = [
        { type: "sun", used: false },
        { type: "moon", used: false },
        { type: "star", used: false }
      ];
      practiceEnterBtn.style.display = "inline-flex";
      practiceExitBtn.style.display = "none";
      log("ê²Œì„ì´ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤. ë¼ìš´ë“œ 1ë¶€í„° ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.", "system");
      render();
    }

    function enterPractice() {
      if (mode === "practice") return;
      mode = "practice";
      field = [];
      hand = [];
      discardPile = [];
      sunUsedThisRound = false;
      drawsThisRound = 0;
      awaitingMoonSelection = false;
      awaitingStarFieldSelection = false;
      awaitingStarColorSelection = null;
      practiceEnterBtn.style.display = "none";
      practiceExitBtn.style.display = "inline-flex";
      log("ì—°ìŠµëª¨ë“œì— ë“¤ì–´ì™”ìŠµë‹ˆë‹¤. í•˜íŠ¸/ë¼ìš´ë“œ ì†Œëª¨ ì—†ì´ ë§ˆìŒê» ì—°ìŠµí•´ë³´ì„¸ìš”.", "system");
      render();
    }

    function exitPractice() {
      if (mode !== "practice") return;
      mode = "normal";
      field = [];
      hand = [];
      discardPile = [];
      sunUsedThisRound = false;
      drawsThisRound = 0;
      awaitingMoonSelection = false;
      awaitingStarFieldSelection = false;
      awaitingStarColorSelection = null;
      practiceEnterBtn.style.display = "inline-flex";
      practiceExitBtn.style.display = "none";
      log("ì—°ìŠµëª¨ë“œë¥¼ ì¢…ë£Œí•˜ê³  ë³¸ ê²Œì„ìœ¼ë¡œ ëŒì•„ì™”ìŠµë‹ˆë‹¤.", "system");
      render();
    }

    // ---- ì´ë²¤íŠ¸ ë°”ì¸ë”© ----
    drawBtn.addEventListener("click", drawThree);
    resetBtn.addEventListener("click", resetGame);
    practiceEnterBtn.addEventListener("click", enterPractice);
    practiceExitBtn.addEventListener("click", exitPractice);

    // ì´ˆê¸° ì‹œì‘
    render();
    log("ë³¸ ê²Œì„ ì‹œì‘! ë¨¼ì € ë¼ìš´ë“œ 1ì—ì„œ ê°ì„ ì¡ì•„ë³´ê³ , í•„ìš”í•˜ë©´ ì˜¤ë¥¸ìª½ ìœ„ 'ì—°ìŠµëª¨ë“œ'ì—ì„œ íŒ¨í„´ì„ ì—°ìŠµí•´ë³´ì„¸ìš”.", "system");
  </script>
</body>
</html>
